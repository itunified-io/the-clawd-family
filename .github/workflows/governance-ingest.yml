# =============================================================================
# Governance Auto-Ingest
# =============================================================================
# Automatically re-ingests governance/AGENT.md into the RAG database
# when it changes. This ensures sub-repos always get the latest governance
# policies via the /api/governance/search endpoint.
#
# Triggers:
#   - Push to main that modifies governance/AGENT.md
#
# Requires:
#   - Dashboard app running at APP_URL (default: http://localhost:3000)
# =============================================================================

name: Governance Ingest

on:
  push:
    branches: [main]
    paths:
      - "governance/AGENT.md"

env:
  APP_URL: ${{ vars.APP_URL || 'http://localhost:3000' }}

jobs:
  ingest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from AGENT.md
        id: version
        run: |
          VERSION=$(grep -m1 '^\*\*Version:\*\*' governance/AGENT.md | sed 's/.*\*\* //')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "::notice::Governance version: $VERSION"

      - name: Ingest AGENT.md into RAG
        run: |
          CONTENT=$(cat governance/AGENT.md | jq -Rs .)

          RESPONSE=$(curl -sf -X POST \
            -H "Content-Type: application/json" \
            "${APP_URL}/api/governance" \
            -d "{\"content\": $CONTENT, \"version\": \"${{ steps.version.outputs.version }}\"}")

          echo "$RESPONSE" | jq .
          echo "::notice::Governance ingested successfully"
